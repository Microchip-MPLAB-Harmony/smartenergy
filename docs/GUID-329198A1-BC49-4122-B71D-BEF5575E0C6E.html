<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Using The Library" />
<meta name="DC.relation" scheme="URI" content="GUID-BF84994F-1D02-4912-91AB-DCB62487A732.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="using-the-library" />
<link rel="stylesheet" type="text/css" href="stylesheets/commonltr.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<link rel="stylesheet" type="text/css" href="./stylesheets/common-extended.css" /><title>Using The Library</title>
<meta name="Microsoft.Help.Id" content="GUID-87F4E49E-0A61-4067-B9CF-1FE226A94F9B-using-the-library" />
<meta name="Microsoft.Help.TocParent" content="GUID-87F4E49E-0A61-4067-B9CF-1FE226A94F9B" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB Harmony Smart Energy Library Reference A 02/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
        function cpy(id, button) {
        
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                    button.textContent = "Copy";
                    button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
              console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
        }
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-329198A1-BC49-4122-B71D-BEF5575E0C6E"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style></head>
<body id="using-the-library">
<h1 class="title topictitle1" id="ariaid-title1">Using The Library</h1><div class="body"><p class="p">The PLC PHY Sniffer library is an add-on that can be used along with the <a class="xref" href="GUID-261B02C6-E685-4C12-8EB7-5E717F054F60.html"><em class="ph i">PLC PHY Driver</em></a> or the <a class="xref" href="GUID-A7685FE8-B336-4379-A26B-C821EBD7CD85.html"><em class="ph i">G3 PLC MAC RT Driver</em></a>.
The PHY or MAC RT driver is the one in charge of PLC communications, while the Sniffer is used to encode the packets containing the PLC frames and then send them through a Serial interface.</p>
<p class="p">Following examples illustrate how to use the Sniffer library (which in turn uses the USI service to send the frames to an external tool), to build a Sniffer application.
Both G3 and PRIME based examples are provided.</p>
<p class="p"><strong class="ph b">Example implementation of a G3 Sniffer</strong></p>
<pre class="pre codeblock language-c"><button title="Copy Code" class="copy-code" onclick="cpy('d5793e27', this);">Copy</button><code id="d5793e27" content="APP_DATA appData;&#xA;    &#xA;static uint8_t pPLCDataRxBuffer[APP_PLC_DATA_BUFFER_SIZE];&#xA;static uint8_t pPLCDataPIBBuffer[APP_PLC_PIB_BUFFER_SIZE];&#xA;static uint8_t pSerialDataBuffer[APP_SERIAL_DATA_BUFFER_SIZE];&#xA;&#xA;static void APP_PLCDataIndCb(DRV_PLC_PHY_RECEPTION_OBJ *indObj, uintptr_t context)&#xA;{&#xA;    /* Send Received PLC message through USI */&#xA;&#x9;if (indObj-&gt;dataLength) {&#xA;        size_t length;&#xA;&#xA;        /* Report RX Symbols */&#xA;        appData.plcPIB.id = PLC_ID_RX_PAY_SYMBOLS;&#xA;        appData.plcPIB.length = 2;&#xA;        DRV_PLC_PHY_PIBGet(appData.drvPl360Handle, &amp;appData.plcPIB);&#xA;&#xA;        SRV_PSNIFFER_SetRxPayloadSymbols(*(uint16_t *)appData.plcPIB.pData);&#xA;&#xA;        /* Add received message */&#xA;        length = SRV_PSNIFFER_SerialRxMessage(appData.pSerialData, indObj);&#xA;        /* Send through USI */&#xA;        SRV_USI_Send_Message(appData.srvUSIHandle, SRV_USI_PROT_ID_SNIFF_G3,&#xA;                appData.pSerialData, length);&#xA;    }&#xA;}&#xA;&#xA;void APP_USIPhyProtocolEventHandler(uint8_t *pData, size_t length)&#xA;{&#xA;    /* Message received from PLC Tool - USART */&#xA;&#x9;uint8_t command;&#xA;&#xA;&#x9;/* Retrieve Command from received message */&#xA;&#x9;command = SRV_PSNIFFER_GetCommand(pData);&#xA;&#xA;&#x9;switch (command) {&#xA;        /* Only TONE_MASK Command expected */&#xA;        case SRV_PSNIFFER_CMD_SET_TONE_MASK:&#xA;        {&#xA;            /* Convert ToneMask from Sniffer Tool to PLC phy layer */&#xA;            SRV_PSNIFFER_ConvertToneMask(appData.plcPIB.pData, pData + 1);&#xA;&#xA;            /* Send data to PLC */&#xA;            appData.plcPIB.id = PLC_ID_TONE_MASK;&#xA;            appData.plcPIB.length = PSNIFFER_CARRIERS_SIZE;&#xA;            DRV_PLC_PHY_PIBSet(appData.drvPl360Handle, &amp;appData.plcPIB);&#xA;&#xA;        }&#xA;        break;&#xA;&#xA;        default:&#xA;            break;&#xA;    }&#xA;}&#xA;&#xA;void APP_Initialize(void)&#xA;{&#xA;    /* Place the App state machine in its initial state. */&#xA;    appData.state = APP_STATE_INIT;&#xA;&#xA;    /* Initialize PLC objects */&#xA;    appData.plcRxObj.pReceivedData = pPLCDataRxBuffer;&#xA;    appData.plcPIB.pData = pPLCDataPIBBuffer;&#xA;    appData.pSerialData = pSerialDataBuffer;&#xA;}&#xA;&#xA;void APP_Tasks(void)&#xA;{&#xA;    /* Check the application's current state. */&#xA;    switch(appData.state)&#xA;    {&#xA;        /* Application's initial state. */&#xA;        case APP_STATE_INIT:&#xA;        {&#xA;            /* Open PLC driver : Start uploading process */&#xA;            appData.drvPl360Handle = DRV_PLC_PHY_Open(DRV_PLC_PHY_INDEX, NULL);&#xA;&#xA;            if (appData.drvPl360Handle != DRV_HANDLE_INVALID)&#xA;            {&#xA;                /* Set Application to next state */&#xA;                appData.state = APP_STATE_REGISTER;&#xA;            }&#xA;            else&#xA;            {&#xA;                /* Set Application to ERROR state */&#xA;                appData.state = APP_STATE_ERROR;&#xA;            }&#xA;            break;&#xA;        }&#xA;&#xA;        /* Waiting to PLC transceiver be opened and register callback functions */&#xA;        case APP_STATE_REGISTER:&#xA;        {&#xA;            /* Check PLC transceiver */&#xA;            if (DRV_PLC_PHY_Status(DRV_PLC_PHY_INDEX) == SYS_STATUS_READY)&#xA;            {&#xA;                /* Register PLC callback */&#xA;                DRV_PLC_PHY_DataIndCallbackRegister(appData.drvPl360Handle,&#xA;                        APP_PLCDataIndCb, DRV_PLC_PHY_INDEX);&#xA;&#xA;                /* Open USI Service */&#xA;                appData.srvUSIHandle = SRV_USI_Open(SRV_USI_INDEX_0);&#xA;&#xA;                if (appData.srvUSIHandle != DRV_HANDLE_INVALID)&#xA;                {&#xA;                    /* Set Application to next state */&#xA;                    appData.state = APP_STATE_CONFIG_USI;&#xA;                }&#xA;                else&#xA;                {&#xA;                    /* Set Application to ERROR state */&#xA;                    appData.state = APP_STATE_ERROR;&#xA;                }&#xA;            }&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_STATE_CONFIG_USI:&#xA;        {&#xA;            if (SRV_USI_Status(appData.srvUSIHandle) == SRV_USI_STATUS_CONFIGURED)&#xA;            {&#xA;                /* Register USI callback */&#xA;                SRV_USI_CallbackRegister(appData.srvUSIHandle,&#xA;                        SRV_USI_PROT_ID_SNIFF_G3, APP_USIPhyProtocolEventHandler);&#xA;                    &#xA;                /* Set Application to next state */&#xA;                appData.state = APP_STATE_READY;&#xA;            }&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_STATE_READY:&#xA;        {&#xA;            /* Check USI status in case of USI device has been reset */&#xA;            if (SRV_USI_Status(appData.srvUSIHandle) == SRV_USI_STATUS_NOT_CONFIGURED)&#xA;            {&#xA;                /* Set Application to next state */&#xA;                appData.state = APP_STATE_CONFIG_USI;&#xA;            }&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_STATE_ERROR:&#xA;        {&#xA;            /* Handle error in application's state machine */&#xA;            break;&#xA;        }&#xA;&#xA;        /* The default state should never be executed. */&#xA;        default:&#xA;        {&#xA;            /* TODO: Handle error in application's state machine. */&#xA;            break;&#xA;        }&#xA;    }&#xA;}">APP_DATA appData<span class="ph token punctuation">;</span>
    
<span class="ph token keyword">static</span> uint8_t pPLCDataRxBuffer<span class="ph token punctuation">[</span>APP_PLC_DATA_BUFFER_SIZE<span class="ph token punctuation">]</span><span class="ph token punctuation">;</span>
<span class="ph token keyword">static</span> uint8_t pPLCDataPIBBuffer<span class="ph token punctuation">[</span>APP_PLC_PIB_BUFFER_SIZE<span class="ph token punctuation">]</span><span class="ph token punctuation">;</span>
<span class="ph token keyword">static</span> uint8_t pSerialDataBuffer<span class="ph token punctuation">[</span>APP_SERIAL_DATA_BUFFER_SIZE<span class="ph token punctuation">]</span><span class="ph token punctuation">;</span>

<span class="ph token keyword">static</span> <span class="ph token keyword">void</span> <span class="ph token function">APP_PLCDataIndCb</span><span class="ph token punctuation">(</span>DRV_PLC_PHY_RECEPTION_OBJ <span class="ph token operator">*</span>indObj<span class="ph token punctuation">,</span> uintptr_t context<span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Send Received PLC message through USI */</span>
	<span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>indObj<span class="ph token operator">-&gt;</span>dataLength<span class="ph token punctuation">)</span> <span class="ph token punctuation">{</span>
        size_t length<span class="ph token punctuation">;</span>

        <span class="ph token comment">/* Report RX Symbols */</span>
        appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>id <span class="ph token operator">=</span> PLC_ID_RX_PAY_SYMBOLS<span class="ph token punctuation">;</span>
        appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>length <span class="ph token operator">=</span> <span class="ph token number">2</span><span class="ph token punctuation">;</span>
        <span class="ph token function">DRV_PLC_PHY_PIBGet</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle<span class="ph token punctuation">,</span> <span class="ph token operator">&amp;</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

        <span class="ph token function">SRV_PSNIFFER_SetRxPayloadSymbols</span><span class="ph token punctuation">(</span><span class="ph token operator">*</span><span class="ph token punctuation">(</span>uint16_t <span class="ph token operator">*</span><span class="ph token punctuation">)</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

        <span class="ph token comment">/* Add received message */</span>
        length <span class="ph token operator">=</span> <span class="ph token function">SRV_PSNIFFER_SerialRxMessage</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>pSerialData<span class="ph token punctuation">,</span> indObj<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
        <span class="ph token comment">/* Send through USI */</span>
        <span class="ph token function">SRV_USI_Send_Message</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle<span class="ph token punctuation">,</span> SRV_USI_PROT_ID_SNIFF_G3<span class="ph token punctuation">,</span>
                appData<span class="ph token punctuation">.</span>pSerialData<span class="ph token punctuation">,</span> length<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">void</span> <span class="ph token function">APP_USIPhyProtocolEventHandler</span><span class="ph token punctuation">(</span>uint8_t <span class="ph token operator">*</span>pData<span class="ph token punctuation">,</span> size_t length<span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Message received from PLC Tool - USART */</span>
	uint8_t command<span class="ph token punctuation">;</span>

	<span class="ph token comment">/* Retrieve Command from received message */</span>
	command <span class="ph token operator">=</span> <span class="ph token function">SRV_PSNIFFER_GetCommand</span><span class="ph token punctuation">(</span>pData<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

	<span class="ph token keyword">switch</span> <span class="ph token punctuation">(</span>command<span class="ph token punctuation">)</span> <span class="ph token punctuation">{</span>
        <span class="ph token comment">/* Only TONE_MASK Command expected */</span>
        <span class="ph token keyword">case</span> SRV_PSNIFFER_CMD_SET_TONE_MASK<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Convert ToneMask from Sniffer Tool to PLC phy layer */</span>
            <span class="ph token function">SRV_PSNIFFER_ConvertToneMask</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData<span class="ph token punctuation">,</span> pData <span class="ph token operator">+</span> <span class="ph token number">1</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

            <span class="ph token comment">/* Send data to PLC */</span>
            appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>id <span class="ph token operator">=</span> PLC_ID_TONE_MASK<span class="ph token punctuation">;</span>
            appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>length <span class="ph token operator">=</span> PSNIFFER_CARRIERS_SIZE<span class="ph token punctuation">;</span>
            <span class="ph token function">DRV_PLC_PHY_PIBSet</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle<span class="ph token punctuation">,</span> <span class="ph token operator">&amp;</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

        <span class="ph token punctuation">}</span>
        <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>

        <span class="ph token keyword">default</span><span class="ph token operator">:</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">void</span> <span class="ph token function">APP_Initialize</span><span class="ph token punctuation">(</span><span class="ph token keyword">void</span><span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Place the App state machine in its initial state. */</span>
    appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_INIT<span class="ph token punctuation">;</span>

    <span class="ph token comment">/* Initialize PLC objects */</span>
    appData<span class="ph token punctuation">.</span>plcRxObj<span class="ph token punctuation">.</span>pReceivedData <span class="ph token operator">=</span> pPLCDataRxBuffer<span class="ph token punctuation">;</span>
    appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData <span class="ph token operator">=</span> pPLCDataPIBBuffer<span class="ph token punctuation">;</span>
    appData<span class="ph token punctuation">.</span>pSerialData <span class="ph token operator">=</span> pSerialDataBuffer<span class="ph token punctuation">;</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">void</span> <span class="ph token function">APP_Tasks</span><span class="ph token punctuation">(</span><span class="ph token keyword">void</span><span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Check the application's current state. */</span>
    <span class="ph token keyword">switch</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>state<span class="ph token punctuation">)</span>
    <span class="ph token punctuation">{</span>
        <span class="ph token comment">/* Application's initial state. */</span>
        <span class="ph token keyword">case</span> APP_STATE_INIT<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Open PLC driver : Start uploading process */</span>
            appData<span class="ph token punctuation">.</span>drvPl360Handle <span class="ph token operator">=</span> <span class="ph token function">DRV_PLC_PHY_Open</span><span class="ph token punctuation">(</span>DRV_PLC_PHY_INDEX<span class="ph token punctuation">,</span> <span class="ph token constant">NULL</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle <span class="ph token operator">!=</span> DRV_HANDLE_INVALID<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Set Application to next state */</span>
                appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_REGISTER<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">else</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Set Application to ERROR state */</span>
                appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_ERROR<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token comment">/* Waiting to PLC transceiver be opened and register callback functions */</span>
        <span class="ph token keyword">case</span> APP_STATE_REGISTER<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Check PLC transceiver */</span>
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span><span class="ph token function">DRV_PLC_PHY_Status</span><span class="ph token punctuation">(</span>DRV_PLC_PHY_INDEX<span class="ph token punctuation">)</span> <span class="ph token operator">==</span> SYS_STATUS_READY<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Register PLC callback */</span>
                <span class="ph token function">DRV_PLC_PHY_DataIndCallbackRegister</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle<span class="ph token punctuation">,</span>
                        APP_PLCDataIndCb<span class="ph token punctuation">,</span> DRV_PLC_PHY_INDEX<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

                <span class="ph token comment">/* Open USI Service */</span>
                appData<span class="ph token punctuation">.</span>srvUSIHandle <span class="ph token operator">=</span> <span class="ph token function">SRV_USI_Open</span><span class="ph token punctuation">(</span>SRV_USI_INDEX_0<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

                <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle <span class="ph token operator">!=</span> DRV_HANDLE_INVALID<span class="ph token punctuation">)</span>
                <span class="ph token punctuation">{</span>
                    <span class="ph token comment">/* Set Application to next state */</span>
                    appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_CONFIG_USI<span class="ph token punctuation">;</span>
                <span class="ph token punctuation">}</span>
                <span class="ph token keyword">else</span>
                <span class="ph token punctuation">{</span>
                    <span class="ph token comment">/* Set Application to ERROR state */</span>
                    appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_ERROR<span class="ph token punctuation">;</span>
                <span class="ph token punctuation">}</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_STATE_CONFIG_USI<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span><span class="ph token function">SRV_USI_Status</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle<span class="ph token punctuation">)</span> <span class="ph token operator">==</span> SRV_USI_STATUS_CONFIGURED<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Register USI callback */</span>
                <span class="ph token function">SRV_USI_CallbackRegister</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle<span class="ph token punctuation">,</span>
                        SRV_USI_PROT_ID_SNIFF_G3<span class="ph token punctuation">,</span> APP_USIPhyProtocolEventHandler<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
                    
                <span class="ph token comment">/* Set Application to next state */</span>
                appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_READY<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_STATE_READY<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Check USI status in case of USI device has been reset */</span>
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span><span class="ph token function">SRV_USI_Status</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle<span class="ph token punctuation">)</span> <span class="ph token operator">==</span> SRV_USI_STATUS_NOT_CONFIGURED<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Set Application to next state */</span>
                appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_CONFIG_USI<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_STATE_ERROR<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Handle error in application's state machine */</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token comment">/* The default state should never be executed. */</span>
        <span class="ph token keyword">default</span><span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* TODO: Handle error in application's state machine. */</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span></code></pre><p class="p"><strong class="ph b">Example implementation of a PRIME Sniffer</strong></p>
<pre class="pre codeblock language-c"><button title="Copy Code" class="copy-code" onclick="cpy('d5793e986', this);">Copy</button><code id="d5793e986" content="APP_DATA appData;&#xA;    &#xA;static uint8_t pPLCDataRxBuffer[APP_PLC_DATA_BUFFER_SIZE];&#xA;static uint8_t pPLCDataPIBBuffer[APP_PLC_PIB_BUFFER_SIZE];&#xA;static uint8_t pSerialDataBuffer[APP_SERIAL_DATA_BUFFER_SIZE];&#xA;&#xA;&#xA;static void APP_PLCDataIndCb(DRV_PLC_PHY_RECEPTION_OBJ *indObj, uintptr_t context)&#xA;{&#xA;    /* Send Received PLC message through USI */&#xA;&#x9;if (indObj-&gt;dataLength) {&#xA;        size_t length;&#xA;        &#xA;        /* Report RX Symbols */&#xA;        appData.plcPIB.id = PLC_ID_RX_PAY_SYMBOLS;&#xA;        appData.plcPIB.length = 2;&#xA;        DRV_PLC_PHY_PIBGet(appData.drvPl360Handle, &amp;appData.plcPIB);&#xA;&#xA;        SRV_PSNIFFER_SetRxPayloadSymbols(*(uint16_t *)appData.plcPIB.pData);&#xA;&#xA;        /* Serialize received message */&#xA;        length = SRV_PSNIFFER_SerialRxMessage(appData.pSerialData, indObj);&#xA;        /* Send through USI */&#xA;        SRV_USI_Send_Message(appData.srvUSIHandle, SRV_USI_PROT_ID_SNIF_PRIME,&#xA;                appData.pSerialData, length);&#xA;    }&#xA;}&#xA;&#xA;void APP_USIPhyProtocolEventHandler(uint8_t *pData, size_t length)&#xA;{&#xA;    /* Message received from PLC Tool - USART */&#xA;&#x9;uint8_t command;&#xA;&#xA;&#x9;/* Process received message */&#xA;&#x9;command = SRV_PSNIFFER_GetCommand(pData);&#xA;&#xA;&#x9;switch (command) {&#xA;        /* Only SET_CHANNEL Command expected */&#xA;        case SRV_PSNIFFER_CMD_SET_CHANNEL:&#xA;        {&#xA;            SRV_PLC_PCOUP_CHANNEL channel;&#xA;            &#xA;            channel = *(pData + 1);&#xA;            &#xA;            if ((appData.channel != channel) &amp;&amp; (channel &gt;= CHN1) &amp;&amp; (channel &lt;= CHN7_CHN8))&#xA;            {&#xA;                appData.channel = channel;&#xA;                &#xA;                /* Set channel configuration */&#xA;                appData.plcPIB.id = PLC_ID_CHANNEL_CFG;&#xA;                appData.plcPIB.length = 1;&#xA;                *appData.plcPIB.pData = channel;&#xA;                DRV_PLC_PHY_PIBSet(appData.drvPl360Handle, &amp;appData.plcPIB);&#xA;                /* Update channel in PSniffer */&#xA;                SRV_PSNIFFER_SetPLCChannel(appData.channel);&#xA;            }&#xA;        }&#xA;        break;&#xA;&#xA;        default:&#xA;            break;&#xA;    }&#xA;}&#xA;&#xA;void APP_Initialize(void)&#xA;{&#xA;    /* Place the App state machine in its initial state. */&#xA;    appData.state = APP_STATE_INIT;&#xA;&#xA;    /* Initialize PLC objects */&#xA;    appData.plcRxObj.pReceivedData = pPLCDataRxBuffer;&#xA;    appData.plcPIB.pData = pPLCDataPIBBuffer;&#xA;    appData.pSerialData = pSerialDataBuffer;&#xA;    &#xA;    /* Init Channel */&#xA;    appData.channel = SRV_PCOUP_Get_Default_Channel();&#xA;}&#xA;&#xA;void APP_Tasks(void)&#xA;{&#xA;    /* Check the application's current state. */&#xA;    switch(appData.state)&#xA;    {&#xA;        /* Application's initial state. */&#xA;        case APP_STATE_INIT:&#xA;        {&#xA;            /* Open PLC driver : Start uploading process */&#xA;            appData.drvPl360Handle = DRV_PLC_PHY_Open(DRV_PLC_PHY_INDEX, NULL);&#xA;&#xA;            if (appData.drvPl360Handle != DRV_HANDLE_INVALID)&#xA;            {&#xA;                /* Set Application to next state */&#xA;                appData.state = APP_STATE_REGISTER;&#xA;            }&#xA;            else&#xA;            {&#xA;                /* Set Application to ERROR state */&#xA;                appData.state = APP_STATE_ERROR;&#xA;            }&#xA;            break;&#xA;        }&#xA;&#xA;        /* Waiting to PLC transceiver be opened and register callback functions */&#xA;        case APP_STATE_REGISTER:&#xA;        {&#xA;            /* Check PLC transceiver */&#xA;            if (DRV_PLC_PHY_Status(DRV_PLC_PHY_INDEX) == SYS_STATUS_READY)&#xA;            {&#xA;                /* Register PLC callback */&#xA;                DRV_PLC_PHY_DataIndCallbackRegister(appData.drvPl360Handle,&#xA;                        APP_PLCDataIndCb, DRV_PLC_PHY_INDEX);&#xA;&#xA;                /* Open USI Service */&#xA;                appData.srvUSIHandle = SRV_USI_Open(SRV_USI_INDEX_0);&#xA;&#xA;                if (appData.srvUSIHandle != DRV_HANDLE_INVALID)&#xA;                {&#xA;                    /* Set Application to next state */&#xA;                    appData.state = APP_STATE_CONFIG_USI;&#xA;                }&#xA;                else&#xA;                {&#xA;                    /* Set Application to ERROR state */&#xA;                    appData.state = APP_STATE_ERROR;&#xA;                }&#xA;            }&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_STATE_CONFIG_USI:&#xA;        {&#xA;            if (SRV_USI_Status(appData.srvUSIHandle) == SRV_USI_STATUS_CONFIGURED)&#xA;            {&#xA;                /* Register USI callback */&#xA;                SRV_USI_CallbackRegister(appData.srvUSIHandle,&#xA;                        SRV_USI_PROT_ID_SNIF_PRIME, APP_USIPhyProtocolEventHandler);&#xA;                &#xA;                /* Set channel configuration */&#xA;                appData.plcPIB.id = PLC_ID_CHANNEL_CFG;&#xA;                appData.plcPIB.length = 1;&#xA;                *appData.plcPIB.pData = appData.channel;&#xA;                DRV_PLC_PHY_PIBSet(appData.drvPl360Handle, &amp;appData.plcPIB);&#xA;                /* Update channel in PSniffer */&#xA;                SRV_PSNIFFER_SetPLCChannel(appData.channel);&#xA;                &#xA;                appData.plcPIB.id = PLC_ID_NUM_CHANNELS;&#xA;                appData.plcPIB.length = 1;&#xA;                if (appData.channel &gt; CHN8) &#xA;                {&#xA;                    *appData.plcPIB.pData = 2;&#xA;                }&#xA;                else&#xA;                {&#xA;                    *appData.plcPIB.pData = 1;&#xA;                }&#xA;                DRV_PLC_PHY_PIBSet(appData.drvPl360Handle, &amp;appData.plcPIB);&#xA;                    &#xA;                /* Set Application to next state */&#xA;                appData.state = APP_STATE_READY;&#xA;            }&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_STATE_READY:&#xA;        {&#xA;            /* Check USI status in case of USI device has been reset */&#xA;            if (SRV_USI_Status(appData.srvUSIHandle) == SRV_USI_STATUS_NOT_CONFIGURED)&#xA;            {&#xA;                /* Set Application to next state */&#xA;                appData.state = APP_STATE_CONFIG_USI;&#xA;            }&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_STATE_ERROR:&#xA;        {&#xA;            /* Handle error in application's state machine */&#xA;            break;&#xA;        }&#xA;&#xA;        /* The default state should never be executed. */&#xA;        default:&#xA;        {&#xA;            /* TODO: Handle error in application's state machine. */&#xA;            break;&#xA;        }&#xA;    }&#xA;}">APP_DATA appData<span class="ph token punctuation">;</span>
    
<span class="ph token keyword">static</span> uint8_t pPLCDataRxBuffer<span class="ph token punctuation">[</span>APP_PLC_DATA_BUFFER_SIZE<span class="ph token punctuation">]</span><span class="ph token punctuation">;</span>
<span class="ph token keyword">static</span> uint8_t pPLCDataPIBBuffer<span class="ph token punctuation">[</span>APP_PLC_PIB_BUFFER_SIZE<span class="ph token punctuation">]</span><span class="ph token punctuation">;</span>
<span class="ph token keyword">static</span> uint8_t pSerialDataBuffer<span class="ph token punctuation">[</span>APP_SERIAL_DATA_BUFFER_SIZE<span class="ph token punctuation">]</span><span class="ph token punctuation">;</span>


<span class="ph token keyword">static</span> <span class="ph token keyword">void</span> <span class="ph token function">APP_PLCDataIndCb</span><span class="ph token punctuation">(</span>DRV_PLC_PHY_RECEPTION_OBJ <span class="ph token operator">*</span>indObj<span class="ph token punctuation">,</span> uintptr_t context<span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Send Received PLC message through USI */</span>
	<span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>indObj<span class="ph token operator">-&gt;</span>dataLength<span class="ph token punctuation">)</span> <span class="ph token punctuation">{</span>
        size_t length<span class="ph token punctuation">;</span>
        
        <span class="ph token comment">/* Report RX Symbols */</span>
        appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>id <span class="ph token operator">=</span> PLC_ID_RX_PAY_SYMBOLS<span class="ph token punctuation">;</span>
        appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>length <span class="ph token operator">=</span> <span class="ph token number">2</span><span class="ph token punctuation">;</span>
        <span class="ph token function">DRV_PLC_PHY_PIBGet</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle<span class="ph token punctuation">,</span> <span class="ph token operator">&amp;</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

        <span class="ph token function">SRV_PSNIFFER_SetRxPayloadSymbols</span><span class="ph token punctuation">(</span><span class="ph token operator">*</span><span class="ph token punctuation">(</span>uint16_t <span class="ph token operator">*</span><span class="ph token punctuation">)</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

        <span class="ph token comment">/* Serialize received message */</span>
        length <span class="ph token operator">=</span> <span class="ph token function">SRV_PSNIFFER_SerialRxMessage</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>pSerialData<span class="ph token punctuation">,</span> indObj<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
        <span class="ph token comment">/* Send through USI */</span>
        <span class="ph token function">SRV_USI_Send_Message</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle<span class="ph token punctuation">,</span> SRV_USI_PROT_ID_SNIF_PRIME<span class="ph token punctuation">,</span>
                appData<span class="ph token punctuation">.</span>pSerialData<span class="ph token punctuation">,</span> length<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">void</span> <span class="ph token function">APP_USIPhyProtocolEventHandler</span><span class="ph token punctuation">(</span>uint8_t <span class="ph token operator">*</span>pData<span class="ph token punctuation">,</span> size_t length<span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Message received from PLC Tool - USART */</span>
	uint8_t command<span class="ph token punctuation">;</span>

	<span class="ph token comment">/* Process received message */</span>
	command <span class="ph token operator">=</span> <span class="ph token function">SRV_PSNIFFER_GetCommand</span><span class="ph token punctuation">(</span>pData<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

	<span class="ph token keyword">switch</span> <span class="ph token punctuation">(</span>command<span class="ph token punctuation">)</span> <span class="ph token punctuation">{</span>
        <span class="ph token comment">/* Only SET_CHANNEL Command expected */</span>
        <span class="ph token keyword">case</span> SRV_PSNIFFER_CMD_SET_CHANNEL<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            SRV_PLC_PCOUP_CHANNEL channel<span class="ph token punctuation">;</span>
            
            channel <span class="ph token operator">=</span> <span class="ph token operator">*</span><span class="ph token punctuation">(</span>pData <span class="ph token operator">+</span> <span class="ph token number">1</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
            
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>channel <span class="ph token operator">!=</span> channel<span class="ph token punctuation">)</span> <span class="ph token operator">&amp;&amp;</span> <span class="ph token punctuation">(</span>channel <span class="ph token operator">&gt;=</span> CHN1<span class="ph token punctuation">)</span> <span class="ph token operator">&amp;&amp;</span> <span class="ph token punctuation">(</span>channel <span class="ph token operator">&lt;=</span> CHN7_CHN8<span class="ph token punctuation">)</span><span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                appData<span class="ph token punctuation">.</span>channel <span class="ph token operator">=</span> channel<span class="ph token punctuation">;</span>
                
                <span class="ph token comment">/* Set channel configuration */</span>
                appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>id <span class="ph token operator">=</span> PLC_ID_CHANNEL_CFG<span class="ph token punctuation">;</span>
                appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>length <span class="ph token operator">=</span> <span class="ph token number">1</span><span class="ph token punctuation">;</span>
                <span class="ph token operator">*</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData <span class="ph token operator">=</span> channel<span class="ph token punctuation">;</span>
                <span class="ph token function">DRV_PLC_PHY_PIBSet</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle<span class="ph token punctuation">,</span> <span class="ph token operator">&amp;</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
                <span class="ph token comment">/* Update channel in PSniffer */</span>
                <span class="ph token function">SRV_PSNIFFER_SetPLCChannel</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>channel<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
        <span class="ph token punctuation">}</span>
        <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>

        <span class="ph token keyword">default</span><span class="ph token operator">:</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">void</span> <span class="ph token function">APP_Initialize</span><span class="ph token punctuation">(</span><span class="ph token keyword">void</span><span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Place the App state machine in its initial state. */</span>
    appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_INIT<span class="ph token punctuation">;</span>

    <span class="ph token comment">/* Initialize PLC objects */</span>
    appData<span class="ph token punctuation">.</span>plcRxObj<span class="ph token punctuation">.</span>pReceivedData <span class="ph token operator">=</span> pPLCDataRxBuffer<span class="ph token punctuation">;</span>
    appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData <span class="ph token operator">=</span> pPLCDataPIBBuffer<span class="ph token punctuation">;</span>
    appData<span class="ph token punctuation">.</span>pSerialData <span class="ph token operator">=</span> pSerialDataBuffer<span class="ph token punctuation">;</span>
    
    <span class="ph token comment">/* Init Channel */</span>
    appData<span class="ph token punctuation">.</span>channel <span class="ph token operator">=</span> <span class="ph token function">SRV_PCOUP_Get_Default_Channel</span><span class="ph token punctuation">(</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">void</span> <span class="ph token function">APP_Tasks</span><span class="ph token punctuation">(</span><span class="ph token keyword">void</span><span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Check the application's current state. */</span>
    <span class="ph token keyword">switch</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>state<span class="ph token punctuation">)</span>
    <span class="ph token punctuation">{</span>
        <span class="ph token comment">/* Application's initial state. */</span>
        <span class="ph token keyword">case</span> APP_STATE_INIT<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Open PLC driver : Start uploading process */</span>
            appData<span class="ph token punctuation">.</span>drvPl360Handle <span class="ph token operator">=</span> <span class="ph token function">DRV_PLC_PHY_Open</span><span class="ph token punctuation">(</span>DRV_PLC_PHY_INDEX<span class="ph token punctuation">,</span> <span class="ph token constant">NULL</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle <span class="ph token operator">!=</span> DRV_HANDLE_INVALID<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Set Application to next state */</span>
                appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_REGISTER<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">else</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Set Application to ERROR state */</span>
                appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_ERROR<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token comment">/* Waiting to PLC transceiver be opened and register callback functions */</span>
        <span class="ph token keyword">case</span> APP_STATE_REGISTER<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Check PLC transceiver */</span>
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span><span class="ph token function">DRV_PLC_PHY_Status</span><span class="ph token punctuation">(</span>DRV_PLC_PHY_INDEX<span class="ph token punctuation">)</span> <span class="ph token operator">==</span> SYS_STATUS_READY<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Register PLC callback */</span>
                <span class="ph token function">DRV_PLC_PHY_DataIndCallbackRegister</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle<span class="ph token punctuation">,</span>
                        APP_PLCDataIndCb<span class="ph token punctuation">,</span> DRV_PLC_PHY_INDEX<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

                <span class="ph token comment">/* Open USI Service */</span>
                appData<span class="ph token punctuation">.</span>srvUSIHandle <span class="ph token operator">=</span> <span class="ph token function">SRV_USI_Open</span><span class="ph token punctuation">(</span>SRV_USI_INDEX_0<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

                <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle <span class="ph token operator">!=</span> DRV_HANDLE_INVALID<span class="ph token punctuation">)</span>
                <span class="ph token punctuation">{</span>
                    <span class="ph token comment">/* Set Application to next state */</span>
                    appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_CONFIG_USI<span class="ph token punctuation">;</span>
                <span class="ph token punctuation">}</span>
                <span class="ph token keyword">else</span>
                <span class="ph token punctuation">{</span>
                    <span class="ph token comment">/* Set Application to ERROR state */</span>
                    appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_ERROR<span class="ph token punctuation">;</span>
                <span class="ph token punctuation">}</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_STATE_CONFIG_USI<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span><span class="ph token function">SRV_USI_Status</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle<span class="ph token punctuation">)</span> <span class="ph token operator">==</span> SRV_USI_STATUS_CONFIGURED<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Register USI callback */</span>
                <span class="ph token function">SRV_USI_CallbackRegister</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle<span class="ph token punctuation">,</span>
                        SRV_USI_PROT_ID_SNIF_PRIME<span class="ph token punctuation">,</span> APP_USIPhyProtocolEventHandler<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
                
                <span class="ph token comment">/* Set channel configuration */</span>
                appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>id <span class="ph token operator">=</span> PLC_ID_CHANNEL_CFG<span class="ph token punctuation">;</span>
                appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>length <span class="ph token operator">=</span> <span class="ph token number">1</span><span class="ph token punctuation">;</span>
                <span class="ph token operator">*</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData <span class="ph token operator">=</span> appData<span class="ph token punctuation">.</span>channel<span class="ph token punctuation">;</span>
                <span class="ph token function">DRV_PLC_PHY_PIBSet</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle<span class="ph token punctuation">,</span> <span class="ph token operator">&amp;</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
                <span class="ph token comment">/* Update channel in PSniffer */</span>
                <span class="ph token function">SRV_PSNIFFER_SetPLCChannel</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>channel<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
                
                appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>id <span class="ph token operator">=</span> PLC_ID_NUM_CHANNELS<span class="ph token punctuation">;</span>
                appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>length <span class="ph token operator">=</span> <span class="ph token number">1</span><span class="ph token punctuation">;</span>
                <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>channel <span class="ph token operator">&gt;</span> CHN8<span class="ph token punctuation">)</span> 
                <span class="ph token punctuation">{</span>
                    <span class="ph token operator">*</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData <span class="ph token operator">=</span> <span class="ph token number">2</span><span class="ph token punctuation">;</span>
                <span class="ph token punctuation">}</span>
                <span class="ph token keyword">else</span>
                <span class="ph token punctuation">{</span>
                    <span class="ph token operator">*</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">.</span>pData <span class="ph token operator">=</span> <span class="ph token number">1</span><span class="ph token punctuation">;</span>
                <span class="ph token punctuation">}</span>
                <span class="ph token function">DRV_PLC_PHY_PIBSet</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>drvPl360Handle<span class="ph token punctuation">,</span> <span class="ph token operator">&amp;</span>appData<span class="ph token punctuation">.</span>plcPIB<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
                    
                <span class="ph token comment">/* Set Application to next state */</span>
                appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_READY<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_STATE_READY<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Check USI status in case of USI device has been reset */</span>
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span><span class="ph token function">SRV_USI_Status</span><span class="ph token punctuation">(</span>appData<span class="ph token punctuation">.</span>srvUSIHandle<span class="ph token punctuation">)</span> <span class="ph token operator">==</span> SRV_USI_STATUS_NOT_CONFIGURED<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Set Application to next state */</span>
                appData<span class="ph token punctuation">.</span>state <span class="ph token operator">=</span> APP_STATE_CONFIG_USI<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_STATE_ERROR<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Handle error in application's state machine */</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token comment">/* The default state should never be executed. */</span>
        <span class="ph token keyword">default</span><span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* TODO: Handle error in application's state machine. */</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span></code></pre></div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-BF84994F-1D02-4912-91AB-DCB62487A732.html">PLC PHY Sniffer Service</a></div>
</div>
</div></body>
</html>