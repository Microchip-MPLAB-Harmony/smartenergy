<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="How the Metrology driver library works" />
<meta name="DC.relation" scheme="URI" content="GUID-2023FB1C-E7E7-4813-9BA3-480FEB57627B.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="how-the-metrology-driver-library-works" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>How the Metrology driver library works</title>
<meta name="Microsoft.Help.Id" content="GUID-87F4E49E-0A61-4067-B9CF-1FE226A94F9B-how-the-metrology-driver-library-works" />
<meta name="Microsoft.Help.TocParent" content="GUID-87F4E49E-0A61-4067-B9CF-1FE226A94F9B" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB Harmony Smart Energy Library Reference A 02/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-21C6829A-CB89-4FE2-A0B6-7467DEAB58C5"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="how-the-metrology-driver-library-works">
<h1 class="title topictitle1" id="ariaid-title1">How the Metrology driver library works</h1><div class="body"><p class="p">This driver has been designed to be only used with PIC32CXMTSH or PIC32CXMTC devices, which are parts of the MISTRAL (PIC32CXMT) device family of the Smart Energy group.</p>
<p class="p">Depending on which device is used, there are some requirements to be considered:</p>
<ul class="ul"><li class="li"><p class="p"><strong class="ph b">PIC32CXMTSH connection</strong></p>
<ul class="ul"><li class="li"><p class="p">This device supports single phase and dual phase (2 voltages and 2 currents).</p>
</li>
<li class="li"><p class="p">AFE is internally provided.</p>
</li>
</ul>
</li>
<li class="li"><p class="p"><strong class="ph b">PIC32CXMTC connection</strong></p>
<ul class="ul"><li class="li"><p class="p">This device supports poly-phase.</p>
</li>
<li class="li"><p class="p">It requires an external AFE, ATSense203.</p>
</li>
</ul>
</li>
</ul>
<p class="p">The Energy Metering AFE collects the data from current sensors and voltage inputs and digitizes voltage and current data. This data is processed by the Metrology library, running on the Core 1 of the PIC32CXMTSH/C microcontroller. The Metrology driver and metering application run on Core 0.</p>
<div class="fig fignone"><div class="figcap"><span class="fig--title-label">Figure 1. </span>Metrology Block Diagram</div><img class="image" src="GUID-5CB1A527-63B6-40FA-98C0-869C53D1FA58-low.png" alt="Metrology_Block_Diagram" /><br /></div>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-2023FB1C-E7E7-4813-9BA3-480FEB57627B.html">Metrology Driver</a></div>
</div>
</div><div class="topic nested1" aria-labelledby="ariaid-title2" id="initialization-process"><h2 class="title topictitle2" id="ariaid-title2">Initialization process</h2><div class="body"><p class="p">After a power up, the metrology driver is responsible of the following points:</p>
<ul class="ul"><li class="li"><p class="p">Initialize and configure IPC (Inter-Processor communication) peripheral.</p>
</li>
<li class="li"><p class="p">Initialize the interface with the metrology library via shared memory.</p>
</li>
<li class="li"><p class="p">If the reset cause of the main processor was not a Watchdog reset:</p>
<ul class="ul"><li class="li"><p class="p">Control reset lines of the coprocessor (second processor) and the peripherals driven by the coprocessor.</p>
</li>
<li class="li"><p class="p">Control clock lines of the coprocessor (second processor) and the peripherals driven by the coprocessor.</p>
</li>
<li class="li"><p class="p">Copy the metrology library application file to the coprocessor execution memory.</p>
</li>
</ul>
</li>
</ul>
<p class="p">A watchdog reset detection is needed in order to avoid any interruption source of the metrology library application from the main processor.</p>
<p class="p">The metrology driver provides an assembly file to include the metrology library application file into the application of the main processor:</p>
<pre class="pre codeblock c">  .section .rodata
  .global met_bin_start
  .global met_bin_end

  .align <span class="hl-number">8</span>
met_bin_start:
  .incbin <span class="hl-string">"./core1_metlib.bin"</span>
  .align <span class="hl-number">8</span>
met_bin_end:</pre><p class="p">A couple of variables are created in order to set the start and end address where the metrology library file can be found in the main application.</p>
<pre class="pre codeblock c"><strong class="hl-keyword">extern</strong> uint8_t met_bin_start;
<strong class="hl-keyword">extern</strong> uint8_t met_bin_end;

<em class="hl-comment">/* Metrology Driver Initialization Data */</em>
DRV_METROLOGY_INIT drvMetrologyInitData = {

    <em class="hl-comment">/* MET bin destination address */</em>
    .regBaseAddress = DRV_METROLOGY_REG_BASE_ADDRESS,

    <em class="hl-comment">/* MET Binary start address */</em>
    .binStartAddress = (uint32_t)&amp;met_bin_start,
    
    <em class="hl-comment">/* MET Binary end address */</em>
    .binEndAddress = (uint32_t)&amp;met_bin_end,
    
};</pre><p class="p">Once the metrology library has been located in the main application, the metrology driver is in charge of copying its content in the execution memory of the coprocessor.</p>
<p class="p">Once the metrology driver has been initialized, it is necessary to call to opening function which is responsible of enabling IPC peripheral and waiting until metrology library application has been started. At this point, metrology control registers are configured and state control data is set to INIT status.</p>
<div class="fig fignone"><div class="figcap"><span class="fig--title-label">Figure 2. </span>Application Initialization Sequence</div><img class="image" src="GUID-9B6667C0-7365-4BF2-BB94-44E8A44967F5-low.png" alt="Metrology_Library_States_Diagram" /><br /></div>
<p class="p">At this point, start function should be called by the main application until the metrology library is in READY status. When it happens, the metrology driver sets the state control data to RUN status and the IPC integration interrupt will be triggered after every integration period.</p>
<p class="p">When an integration period interrupt has been triggered by the metrology library application, a callback function will be used to notify this event to the main application. When it happens, the update measurements function should be called to obtain the RMS values and all the metrology events properly.</p>
</div>
</div>
</body>
</html>