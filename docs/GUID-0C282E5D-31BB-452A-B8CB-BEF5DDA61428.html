<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="How the Library Works" />
<meta name="DC.relation" scheme="URI" content="GUID-F2657150-3DEB-4EEC-B99F-22FCD8A400C0.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="how-the-library-works" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>How the Library Works</title>
<meta name="Microsoft.Help.Id" content="GUID-87F4E49E-0A61-4067-B9CF-1FE226A94F9B-how-the-library-works" />
<meta name="Microsoft.Help.TocParent" content="GUID-87F4E49E-0A61-4067-B9CF-1FE226A94F9B" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB Harmony Smart Energy Library Reference A 02/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-0C282E5D-31BB-452A-B8CB-BEF5DDA61428"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="how-the-library-works">
<h1 class="title topictitle1" id="ariaid-title1">How the Library Works</h1><div class="body"><p class="p">USI service is a wrapper that provides the interface between the Smart Energy stacks and the serial communications channel (UART or USB CDC).</p>
<p class="p">For USI message transmission, <a class="xref" href="GUID-0A58D291-CDCA-4C22-BAE0-D55E4517D530.html"><em class="ph i">SRV_USI_Send_Message</em></a> function is provided, which packs the data into USI frame format and sends the message through serial interface.</p>
<p class="p">For USI message reception, the service unpacks the data and passes it through callback (<a class="xref" href="GUID-C0B40EB5-8C77-4961-8932-C0C247B4FA29.html"><em class="ph i">SRV_USI_CallbackRegister</em></a>) to the corresponding client depending on the USI protocol.</p>
<p class="p">In the other side of the serial interface, a similar implementation is needed in an external device to pack/unpack USI messages for the corresponding USI protocol. Microchip provides PC tools and Python libraries, which are used to manage different layers of the Smart Energy stacks.</p>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-F2657150-3DEB-4EEC-B99F-22FCD8A400C0.html">USI Service</a></div>
</div>
</div><div class="topic nested1" aria-labelledby="ariaid-title2" id="usi-frame-format"><h2 class="title topictitle2" id="ariaid-title2">USI Frame Format</h2><div class="body"><p class="p">The USI frame format is based on the HDLC specification used along with DLMS. The Serial Communications Profile of the Management Plane defined in the PRIME specification also uses the same format. Below is the structure of the USI frame and field description.</p>
<div class="fig fignone"><div class="figcap"><span class="fig--title-label">Figure 1. </span>USI Frame Format</div><img class="image" src="GUID-58E362D0-40B9-4360-B2B7-7610E2404FE0-low.png" alt="USI general frame format" /><br /></div>
<ul class="ul"><li class="li"><p class="p"><strong class="ph b">0x7E</strong>: Frame start/end identifier.</p>
</li>
<li class="li"><p class="p"><strong class="ph b">MSG LENGTH</strong>: Message payload length in bytes (<strong class="ph b">MESSAGE DATA</strong> field).</p>
</li>
<li class="li"><p class="p"><strong class="ph b">PROTOCOL ID</strong>: USI protocol identifier.</p>
</li>
<li class="li"><p class="p"><strong class="ph b">MESSAGE DATA</strong>: Message payload (variable length). The format is defined by each protocol.</p>
</li>
<li class="li"><p class="p"><strong class="ph b">CRC</strong>:  Error detection code for the message. The CRC size is defined by each protocol (see the table below). For more information about CRC format, see <a class="xref" href="GUID-4E896D85-86B1-4721-880B-214CEE3819BE.html"><em class="ph i">PLC CRC Service</em></a></p>
</li>
</ul>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d6207e87"><span>USI Protocol (<a class="xref" href="GUID-0C07CB6E-5CF9-4C7E-AC48-965198152AAF.html"><em class="ph i">SRV_USI_PROTOCOL_ID Enum</em></a>)</span></th>
<th class="entry cellrowborder" style="text-align:center;vertical-align:middle;" id="d6207e94"><span>PROTOCOL ID</span></th>
<th class="entry cellrowborder" style="text-align:center;vertical-align:middle;" id="d6207e96"><span>CRC size (bits)</span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_MNGP_PRIME</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x00-0x07</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>32</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_SNIF_PRIME</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x13</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>16</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_PHY_SERIAL_PRIME</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x1F</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>16</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_PHY</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x22</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>16</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_SNIFF_G3</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x23</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>16</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_MAC_G3</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x24</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>16</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_ADP_G3</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x25</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>16</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_COORD_G3</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x26</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>16</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d6207e87 "><span>SRV_USI_PROT_ID_PRIME_API</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e94 "><span>0x30</span></td>
<td class="entry cellrowborder" style="text-align:center;vertical-align:middle;" headers="d6207e96 "><span>8</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p">In order to detect the end of the message properly, it is needed to add escape bytes to all fields described above:</p>
<ul class="ul"><li class="li"><p class="p"><strong class="ph b">0x7E</strong> bytes are replaced by <strong class="ph b">0x7D5E</strong> (2 bytes)</p>
</li>
<li class="li"><p class="p"><strong class="ph b">0x7D</strong> bytes are replaced by <strong class="ph b">0x7D5D</strong> (2 bytes)</p>
</li>
</ul>
<p class="p">This adds overhead and has to be considered when configuring the <a class="xref" href="GUID-A3663EE4-FB02-4CF3-BD0E-2BE3FED24123.html"><em class="ph i">size of USI service buffers</em></a>. The size of transmission buffers must be at least twice the size of the biggest message payload used (for the very worst case, all bytes 0x7E or 0x7D).</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title3" id="usi-protocols"><h2 class="title topictitle2" id="ariaid-title3">USI Protocols</h2><div class="body"><p class="p">Each protocol defines its own frame format for the USI payload data. A specific PC tool or Python library is provided for each protocol.</p>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title4" id="phy-sniffer"><h3 class="title topictitle3" id="ariaid-title4">PHY Sniffer</h3><div class="body"><p class="p">There are two USI protocols used to communicate with <em class="ph i">Microchip Hybrid Sniffer Tool</em>, one for PRIME (<em class="ph i">SRV_USI_PROT_ID_SNIF_PRIME</em>) and one for G3 (<em class="ph i">SRV_USI_PROT_ID_SNIFF_G3</em>).</p>
<p class="p">For more information, see <a class="xref" href="GUID-BF84994F-1D02-4912-91AB-DCB62487A732.html"><em class="ph i">PLC PHY Sniffer Service</em></a>.</p>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title5" id="plc-phy-serial"><h3 class="title topictitle3" id="ariaid-title5">PLC PHY Serial</h3><div class="body"><p class="p">There is one USI protocol used to serialize PLC PHY API (<em class="ph i">SRV_USI_PROT_ID_PHY</em>) and communicate with <em class="ph i">Microchip PLC PHY Tester Tool</em> or <em class="ph i">Microchip PLC PHY Python Libraries</em>. The protocol defines different sub-format for G3 and PRIME.</p>
<p class="p">For more information, see <a class="xref" href="GUID-9CCE1919-6FB5-41BE-90E8-9A12F57D6D61.html"><em class="ph i">PLC PHY Serial Service</em></a>.</p>
</div>
</div>
</div>
</body>
</html>